# 태스크 컨텍스트 및 진행사항

## 현재 태스크: 2단계 인증 시스템 구현 준비

### 태스크 개요
- **목표**: OAuth 2.0 기반 Microsoft Graph API 인증 시스템 구현
- **범위**: Authorization Code Flow 및 Device Code Flow 지원
- **우선순위**: 높음 (프로젝트 핵심 기능)

### 태스크 상세 요구사항

#### 1. OAuth 2.0 Authorization Code Flow
- 웹 브라우저 기반 인증 플로우
- 인증 URL 생성 및 리디렉션 처리
- 인증 코드를 액세스 토큰으로 교환
- 리프레시 토큰을 통한 자동 갱신

#### 2. Device Code Flow
- 브라우저 없는 환경에서의 인증
- 디바이스 코드 및 사용자 코드 생성
- 폴링을 통한 인증 상태 확인
- 토큰 획득 및 저장

#### 3. 토큰 관리
- 액세스 토큰 및 리프레시 토큰 암호화 저장
- 토큰 만료 감지 및 자동 갱신
- 토큰 무효화 (로그아웃)

## 이전 태스크 완료 내역

### 1단계: 기초구축 (완료)
**기간**: 프로젝트 시작 ~ 현재
**주요 성과**:
- ✅ 클린 아키텍처 기반 프로젝트 구조 설계
- ✅ 계정 관리 시스템 (CRUD) 완전 구현
- ✅ CLI 인터페이스 구현 및 테스트
- ✅ 데이터베이스 설계 및 SQLAlchemy 연동
- ✅ 포트/어댑터 패턴 적용

**주요 이슈 및 해결**:
1. **계정 삭제 기능 누락**
   - 문제: CLI에 delete 명령어 미구현
   - 해결: delete_account 명령어 추가, --force 옵션 구현
   - 테스트: test@example.com 계정 삭제 성공

2. **인증 타입 변경 로직**
   - 문제: 인증 타입 변경 시 기존 설정 처리 방법 불명확
   - 해결: 단순 enum 값 변경으로 처리, 설정은 별도 관리
   - 테스트: kimghw@krs.co.kr 계정 AUTH_CODE → DEVICE_CODE 변경 성공

**최종 상태**:
- 실제 Azure 계정(kimghw@krs.co.kr) 등록 및 관리 성공
- 모든 CRUD 기능 정상 작동 확인
- 사용자 만족도: "조회하고 등록하는 기능은 잘 된거 같아요"

## 현재 태스크 진행 계획

### Phase 1: 기존 코드 분석 및 확장 계획
**목표**: 기존 엔티티, 포트, 유즈케이스 재사용 방안 검토
**작업 항목**:
- [ ] 기존 AuthCodeConfig, DeviceCodeConfig 엔티티 검토
- [ ] authentication.py 유즈케이스 분석
- [ ] 필요한 새 엔티티 및 포트 식별
- [ ] 토큰 저장을 위한 데이터 모델 설계

### Phase 2: 토큰 관리 엔티티 구현
**목표**: 토큰 저장 및 관리를 위한 도메인 모델 구현
**작업 항목**:
- [ ] AccessToken, RefreshToken 엔티티 정의
- [ ] TokenRepository 포트 인터페이스 정의
- [ ] 토큰 암호화/복호화 로직 설계

### Phase 3: OAuth 클라이언트 어댑터 구현
**목표**: Microsoft Graph API OAuth 연동
**작업 항목**:
- [ ] HTTP 클라이언트 라이브러리 추가 (httpx)
- [ ] OAuth 클라이언트 어댑터 구현
- [ ] 인증 플로우별 구체적 구현

### Phase 4: CLI 인증 명령어 구현
**목표**: 사용자가 CLI를 통해 인증할 수 있는 인터페이스 제공
**작업 항목**:
- [ ] auth 명령어 그룹 생성
- [ ] login, status, refresh, logout 명령어 구현
- [ ] 인증 상태 시각화 (Rich 활용)

### Phase 5: 통합 테스트 및 검증
**목표**: 실제 Azure AD와 연동하여 전체 플로우 검증
**작업 항목**:
- [ ] 실제 Azure 앱 등록 및 설정
- [ ] Authorization Code Flow 테스트
- [ ] Device Code Flow 테스트
- [ ] 토큰 갱신 테스트

## 기술적 고려사항

### 보안 요구사항
- **토큰 암호화**: cryptography 라이브러리 사용
- **환경변수 관리**: Azure 앱 등록 정보 보안
- **HTTPS 강제**: 프로덕션 환경에서 필수

### 성능 고려사항
- **비동기 HTTP 요청**: httpx 또는 aiohttp 사용
- **토큰 캐싱**: 메모리 캐시로 성능 최적화
- **연결 풀링**: HTTP 클라이언트 연결 재사용

### 사용자 경험
- **명확한 인증 상태**: 현재 로그인 상태 표시
- **에러 메시지**: 인증 실패 시 명확한 안내
- **진행 상황 표시**: 긴 인증 과정에서 프로그레스 표시

## 예상 위험 요소 및 대응 방안

### 1. Azure AD 설정 복잡성
**위험**: Azure 앱 등록 및 권한 설정 오류
**대응**: 
- 단계별 설정 가이드 문서 작성
- 최소 권한 원칙 적용
- 테스트 환경에서 충분한 검증

### 2. 토큰 보안 이슈
**위험**: 토큰 저장 및 전송 과정에서 보안 취약점
**대응**:
- 업계 표준 암호화 방식 적용
- 토큰 만료 시간 최소화
- 정기적인 보안 검토

### 3. 네트워크 연결 문제
**위험**: Microsoft Graph API 연결 실패
**대응**:
- 재시도 로직 구현
- 타임아웃 설정 최적화
- 오프라인 모드 고려

## 성공 기준

### 기능적 요구사항
- [ ] Authorization Code Flow로 성공적인 인증
- [ ] Device Code Flow로 성공적인 인증
- [ ] 토큰 자동 갱신 기능 작동
- [ ] 인증 상태 정확한 표시
- [ ] 로그아웃 시 토큰 완전 삭제

### 비기능적 요구사항
- [ ] 인증 과정 30초 이내 완료
- [ ] 토큰 암호화 저장 확인
- [ ] CLI 명령어 직관적 사용
- [ ] 에러 상황 적절한 처리
- [ ] 기존 계정 관리 기능과 완전 통합

## 다음 단계 준비사항

### 3단계: Graph API 연동 준비
- 인증된 토큰을 사용한 API 호출 테스트
- 메일 조회/발송 기능 설계
- API 응답 데이터 모델링

### 4단계: REST API 서버 준비
- FastAPI 라우터 설계
- 인증 미들웨어 구현 계획
- API 문서화 전략
